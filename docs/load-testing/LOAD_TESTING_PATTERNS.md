# Todo アプリ負荷テストパターン

## 概要

Next.js/TypeScript + Prisma + PostgreSQL を使用した Todo アプリに対する負荷テストパターンを定義します。

## システム構成

- **フロントエンド**: Next.js 14 (App Router)
- **バックエンド**: Next.js API Routes
- **データベース**: PostgreSQL + Prisma ORM
- **認証**: アカウントベース（accountId）

## API エンドポイント

### アカウント管理

- `GET /api/accounts` - アカウント一覧取得
- `POST /api/accounts` - アカウント作成
- `GET /api/accounts/[id]` - アカウント詳細取得
- `PUT /api/accounts/[id]` - アカウント更新
- `DELETE /api/accounts/[id]` - アカウント削除

### タスク管理

- `GET /api/tasks?accountId=xxx` - タスク一覧取得
- `POST /api/tasks` - タスク作成
- `GET /api/tasks/[id]` - タスク詳細取得
- `PUT /api/tasks/[id]` - タスク更新
- `DELETE /api/tasks/[id]` - タスク削除

## 負荷テストパターン

### 1. 基本負荷テスト

#### 1.1 単一ユーザー負荷テスト

```bash
# パターン: 1ユーザーが継続的に操作
- スレッド数: 1
- 継続時間: 5分
- 操作: タスク作成 → 取得 → 更新 → 削除の繰り返し
```

#### 1.2 複数ユーザー負荷テスト

```bash
# パターン: 複数ユーザーが同時操作
- スレッド数: 10, 50, 100, 200
- 継続時間: 10分
- 操作: 各ユーザーが独立してタスク操作
```

### 2. ストレステスト

#### 2.1 高負荷ストレステスト

```bash
# パターン: システム限界を超える負荷
- スレッド数: 500, 1000, 2000
- 継続時間: 30分
- 目標: システムの限界点を特定
```

#### 2.2 メモリリークテスト

```bash
# パターン: 長時間実行でのメモリ使用量
- スレッド数: 100
- 継続時間: 2時間
- 監視: メモリ使用量、DB接続数
```

### 3. 機能別負荷テスト

#### 3.1 タスク作成負荷テスト

```bash
# パターン: 大量のタスク作成
- スレッド数: 50
- 継続時間: 5分
- 操作: タスク作成のみ
- データ量: 1アカウントあたり1000タスク
```

#### 3.2 タスク取得負荷テスト

```bash
# パターン: 大量データの取得
- スレッド数: 100
- 継続時間: 10分
- 操作: タスク一覧取得のみ
- データ量: 1アカウントあたり10000タスク
```

#### 3.3 同時更新負荷テスト

```bash
# パターン: 同一タスクの同時更新
- スレッド数: 20
- 継続時間: 5分
- 操作: 同一タスクの同時更新
- 目的: 競合状態の検証
```

### 4. データベース負荷テスト

#### 4.1 大量データテスト

```bash
# パターン: 大量データでの性能
- アカウント数: 1000
- タスク数: 100,000
- 操作: 検索、ソート、ページネーション
```

#### 4.2 インデックス効果テスト

```bash
# パターン: インデックスの有無での性能比較
- データ量: 1,000,000タスク
- 操作: accountIdでの検索
- 比較: インデックス有無での応答時間
```

### 5. ネットワーク負荷テスト

#### 5.1 帯域幅テスト

```bash
# パターン: ネットワーク帯域の限界
- スレッド数: 200
- 継続時間: 10分
- 操作: 大量データの取得
- 監視: ネットワーク使用量
```

#### 5.2 レイテンシテスト

```bash
# パターン: 地理的に分散したアクセス
- 地域: 複数地域からのアクセス
- 操作: 基本的なCRUD操作
- 監視: 応答時間の分布
```

### 6. セキュリティ負荷テスト

#### 6.1 不正アクセステスト

```bash
# パターン: 不正なaccountIdでのアクセス
- スレッド数: 100
- 継続時間: 5分
- 操作: 存在しないaccountIdでのアクセス
- 目的: セキュリティとパフォーマンスの両立
```

#### 6.2 SQL インジェクションテスト

```bash
# パターン: 悪意のあるクエリでの負荷
- 操作: SQLインジェクション攻撃のシミュレーション
- 目的: セキュリティ対策の性能影響
```

## 監視指標

### アプリケーション指標

- **応答時間**: 平均、95 パーセンタイル、99 パーセンタイル
- **スループット**: リクエスト/秒
- **エラー率**: 4xx, 5xx エラーの割合
- **メモリ使用量**: ヒープメモリ、非ヒープメモリ

### データベース指標

- **接続数**: アクティブ接続数、待機接続数
- **クエリ実行時間**: 平均実行時間、スロークエリ
- **ロック待機**: デッドロック、ロック待機時間
- **ディスク I/O**: 読み書き速度、使用率

### インフラ指標

- **CPU 使用率**: アプリケーション、データベース
- **メモリ使用率**: システム全体
- **ディスク使用率**: 容量、I/O 待機時間
- **ネットワーク**: 帯域使用量、パケット損失

## テストシナリオ例

### シナリオ 1: 通常業務負荷

```bash
# 10ユーザーが1時間継続操作
- アカウント作成: 10%
- タスク作成: 40%
- タスク取得: 30%
- タスク更新: 15%
- タスク削除: 5%
```

### シナリオ 2: ピーク時間負荷

```bash
# 100ユーザーが30分集中操作
- タスク取得: 60%
- タスク更新: 30%
- タスク作成: 10%
```

### シナリオ 3: データ移行負荷

```bash
# 大量データの一括処理
- アカウント作成: 1000件
- タスク作成: 100,000件
- バッチ処理での性能測定
```

## 推奨テストツール

### JMeter 設定例

```xml
<!-- スレッドグループ設定 -->
<ThreadGroup>
  <elementProp name="ThreadGroup.main_controller" elementType="LoopController">
    <stringProp name="LoopController.loops">-1</stringProp>
  </elementProp>
  <stringProp name="ThreadGroup.num_threads">100</stringProp>
  <stringProp name="ThreadGroup.ramp_time">60</stringProp>
</ThreadGroup>
```

### カスタムテスト計画

- **HTTP Request**: API エンドポイントへのリクエスト
- **JSON Extractor**: レスポンスから ID を抽出
- **CSV Data Set**: テストデータの管理
- **Response Assertion**: レスポンス検証
- **Summary Report**: 結果レポート生成

## 期待される結果

### 性能目標

- **応答時間**: 95%のリクエストが 500ms 以内
- **スループット**: 1000 リクエスト/秒以上
- **エラー率**: 1%以下
- **可用性**: 99.9%以上

### スケーラビリティ目標

- **同時ユーザー**: 1000 ユーザー
- **データ量**: 100 万タスク
- **アカウント数**: 1 万アカウント
- **ピーク負荷**: 通常の 3 倍の負荷に対応
